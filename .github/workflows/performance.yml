name: Performance Suite

on:
  push:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  run-tests:
    runs-on: ubuntu-latest
    env:
      BASE_URL: ${{ secrets.PERF_BASE_URL }}
      EMAIL: ${{ secrets.PERF_EMAIL }}
      PASSWORD: ${{ secrets.PERF_PASSWORD }}
      PGHOST: ${{ secrets.PERF_DB_HOST }}
      PGDATABASE: ${{ secrets.PERF_DB_NAME }}
      PGUSER: ${{ secrets.PERF_DB_USER }}
      PGPASSWORD: ${{ secrets.PERF_DB_PASSWORD }}
    steps:
      - uses: actions/checkout@v4

      - name: Build performance test image
        run: docker build -t polanji-perf .

      - name: Run performance + DB validation suite
        run: |
          rm -rf artifacts
          mkdir -p artifacts
          docker run --rm \
            -e BASE_URL \
            -e EMAIL \
            -e PASSWORD \
            -e PGHOST \
            -e PGDATABASE \
            -e PGUSER \
            -e PGPASSWORD \
            -v ${{ github.workspace }}/artifacts:/app/artifacts \
            polanji-perf

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-report
          path: artifacts
